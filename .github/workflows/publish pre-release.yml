name: Publish Pre-release Extension

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version increment type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  push:
    branches:
      - main
    paths:
      - '**.tmLanguage.json'
      - '**.tmLanguage.simple.json'
      - '**.tmLanguage.full.json'
      - '**.language-configuration.json'
      - '**.ts'

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      vsix_filename: ${{ steps.get_version.outputs.vsix_filename }}
    steps:
      - uses: actions/checkout@master
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: |
          npm i
          npm install -g typescript "@vscode/vsce" "ovsx"

      - name: Build Extension
        run: |
          npm run compile

      - name: Run Tests
        run: |
          npm run test

      - name: Setup Git
        run: |
          git config --global user.name "Oleksandr K."
          git config --global user.email "${{ secrets.AUTHOR_EMAIL }}"

      - name: Commit Build Changes
        run: |
          git add .
          git diff-index --quiet HEAD || git commit -m "Build changes for pre-release"

      - name: Publish to Marketplace
        run: |
          # Use the version increment type from input, default to patch
          VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
          npx vsce publish $VERSION_TYPE --pre-release --no-yarn
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Get Updated Version and Build VSIX
        id: get_updated_version
        run: |
          # Get the updated version after publishing
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Updated version: $NEW_VERSION"
          
          # Build VSIX with the updated version
          vsce package --pre-release --no-yarn
          
          # Get the VSIX filename
          VSIX_FILE=$(ls *.vsix | head -1)
          echo "vsix_filename=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "Built VSIX file: $VSIX_FILE"

      - name: Create Git Tag and Push
        run: |
          NEW_VERSION="${{ steps.get_updated_version.outputs.new_version }}"
          # Commit any remaining changes (like updated package.json)
          git add .
          git diff-index --quiet HEAD || git commit -m "Version bump to $NEW_VERSION for pre-release"
          
          # Create tag only if it doesn't exist
          if ! git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "Creating new tag v$NEW_VERSION"
            git tag "v$NEW_VERSION"
          else
            echo "Tag v$NEW_VERSION already exists, skipping tag creation"
          fi
          
          # Push changes and tags
          git push origin main
          git push origin "v$NEW_VERSION" || echo "Tag v$NEW_VERSION already exists on remote, continuing..."

      - name: Create GitHub Pre-release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          draft: false
          title: "Gosu Language Support v${{ steps.get_updated_version.outputs.new_version }} - Pre-release"
          automatic_release_tag: "v${{ steps.get_updated_version.outputs.new_version }}"
          files: ${{ steps.get_updated_version.outputs.vsix_filename }}
